// EMAIL REPORT SERVICE F√úR UNWRITTEN STUDIO
// Sendet automatisch Analytics Reports an angelica.gomez@unwritten.studio

const http = require('http');
const url = require('url');

const PORT = 3000;
const RECIPIENT_EMAIL = 'angelica.gomez@unwritten.studio';

// Fake Email Service (in Production w√ºrde man SendGrid, Nodemailer, etc. verwenden)
function sendEmail(to, subject, htmlBody) {
    console.log(`üìß Email w√ºrde gesendet an: ${to}`);
    console.log(`Subject: ${subject}`);
    console.log(`Body: ${htmlBody}`);
    
    // In einer echten App w√ºrde hier ein Email Service wie SendGrid verwendet:
    // const sgMail = require('@sendgrid/mail');
    // sgMail.setApiKey(process.env.SENDGRID_API_KEY);
    // return sgMail.send({ to, from: 'noreply@unwritten.studio', subject, html: htmlBody });
    
    return Promise.resolve({ success: true });
}

function generateHTMLReport(surveyData) {
    const stats = calculateStats(surveyData);
    const showcases = getTopShowcases(surveyData);
    const emotions = getEmotionDistribution(surveyData);
    const content = getContentPriorities(surveyData);

    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #3987b8 0%, #2a5f8d 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }
        .header h1 { margin: 0; }
        .stat-box { background: #f5f7fa; padding: 15px; margin: 10px 0; border-left: 4px solid #3987b8; border-radius: 4px; }
        .stat-value { font-size: 28px; font-weight: bold; color: #3987b8; }
        .stat-label { font-size: 12px; text-transform: uppercase; color: #666; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #3987b8; color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f5f7fa; }
        .footer { background: #f5f7fa; padding: 20px; margin-top: 30px; border-radius: 8px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Unwritten Studio Analytics Report</h1>
            <p>Automatisch generiert am ${new Date().toLocaleString('de-DE')}</p>
        </div>

        <h2>üìà Zusammenfassung</h2>
        
        <div class="stat-box">
            <div class="stat-label">Gesamt Umfragen</div>
            <div class="stat-value">${surveyData.length}</div>
        </div>

        <div class="stat-box">
            <div class="stat-label">Durchschnittlicher NPS Score</div>
            <div class="stat-value">${stats.avgNps}/10</div>
        </div>

        <div class="stat-box">
            <div class="stat-label">Design Rating</div>
            <div class="stat-value">${stats.avgDesign}/5</div>
        </div>

        <div class="stat-box">
            <div class="stat-label">Konzept Klarheit</div>
            <div class="stat-value">${stats.avgClarity}/5</div>
        </div>

        <h2>üåç Top Showcases (Most Clicks)</h2>
        <table>
            <tr>
                <th>Showcase</th>
                <th>Klicks</th>
                <th>Prozentual</th>
            </tr>
            ${showcases.map(([name, count]) => `
            <tr>
                <td>${name}</td>
                <td>${count}</td>
                <td>${Math.round((count / surveyData.length) * 100)}%</td>
            </tr>
            `).join('')}
        </table>

        <h2>üòä Emotionale Reaktionen</h2>
        <table>
            <tr>
                <th>Emotion</th>
                <th>Count</th>
                <th>Prozentual</th>
            </tr>
            ${emotions.map(([emotion, count, percent]) => `
            <tr>
                <td>${emotion}</td>
                <td>${count}</td>
                <td>${percent}%</td>
            </tr>
            `).join('')}
        </table>

        <h2>üí° Gew√ºnschte Inhalte</h2>
        <table>
            <tr>
                <th>Content Typ</th>
                <th>Stimmen</th>
            </tr>
            ${content.map(([name, count]) => `
            <tr>
                <td>${name}</td>
                <td>${count}</td>
            </tr>
            `).join('')}
        </table>

        <div class="footer">
            <p><strong>Datenquellen:</strong> Unwritten Studio Feedback Platform</p>
            <p><strong>Automatischer Report:</strong> Diese Daten werden t√§glich aktualisiert</p>
            <p><strong>Kontakt:</strong> angelica.gomez@unwritten.studio</p>
        </div>
    </div>
</body>
</html>
    `;
}

function calculateStats(surveys) {
    const npsScores = surveys.map(s => parseInt(s.answers.q12?.[0] || 0)).filter(n => n > 0);
    const designScores = surveys.map(s => parseInt(s.answers.q5?.[0] || 0)).filter(n => n > 0);
    const clarityScores = surveys.map(s => parseInt(s.answers.q3?.[0] || 0)).filter(n => n > 0);

    return {
        avgNps: npsScores.length > 0 ? (npsScores.reduce((a, b) => a + b, 0) / npsScores.length).toFixed(1) : '0',
        avgDesign: designScores.length > 0 ? (designScores.reduce((a, b) => a + b, 0) / designScores.length).toFixed(1) : '0',
        avgClarity: clarityScores.length > 0 ? (clarityScores.reduce((a, b) => a + b, 0) / clarityScores.length).toFixed(1) : '0'
    };
}

function getTopShowcases(surveys) {
    const showcases = ['Pantopia', 'Thesis', 'Wetware', 'Libraries', 'Hallo'];
    const counts = {};
    showcases.forEach(s => counts[s] = 0);

    surveys.forEach(s => {
        const selected = s.answers.q4 || [];
        if (Array.isArray(selected)) {
            selected.forEach(item => {
                if (counts[item] !== undefined) counts[item]++;
            });
        }
    });

    return Object.entries(counts).sort((a, b) => b[1] - a[1]);
}

function getEmotionDistribution(surveys) {
    const emotions = ['Inspiriert', 'Neugierig', 'Verwirrt', 'Neutral'];
    const counts = {};
    emotions.forEach(e => counts[e] = 0);

    surveys.forEach(s => {
        const emotion = s.answers.q2?.[0];
        if (emotion && counts[emotion] !== undefined) counts[emotion]++;
    });

    const total = surveys.length || 1;
    return Object.entries(counts).map(([emotion, count]) => [emotion, count, Math.round((count / total) * 100)]);
}

function getContentPriorities(surveys) {
    const contents = {
        'Pricing': 0,
        'UseCases': 0,
        'TechDetails': 0,
        'Testimonials': 0,
        'Demos': 0
    };

    surveys.forEach(s => {
        const selected = s.answers.q8 || [];
        if (Array.isArray(selected)) {
            selected.forEach(item => {
                if (contents[item] !== undefined) contents[item]++;
            });
        }
    });

    const labels = {
        'Pricing': 'üí∞ Pricing',
        'UseCases': 'üéØ Use Cases',
        'TechDetails': 'üîß Tech Details',
        'Testimonials': 'üí¨ Testimonials',
        'Demos': 'üì∫ Demos'
    };

    return Object.entries(contents).map(([key, count]) => [labels[key], count]).sort((a, b) => b[1] - a[1]);
}

// Create HTTP Server
const server = http.createServer((req, res) => {
    const parsedUrl = url.parse(req.url, true);
    const pathname = parsedUrl.pathname;
    const query = parsedUrl.query;

    res.setHeader('Content-Type', 'application/json');
    res.setHeader('Access-Control-Allow-Origin', '*');

    if (pathname === '/api/send-report' && req.method === 'POST') {
        let body = '';

        req.on('data', chunk => {
            body += chunk.toString();
        });

        req.on('end', async () => {
            try {
                const surveyData = JSON.parse(body);
                const htmlReport = generateHTMLReport(surveyData);

                await sendEmail(
                    RECIPIENT_EMAIL,
                    'üìä Unwritten Studio Analytics Report',
                    htmlReport
                );

                res.writeHead(200);
                res.end(JSON.stringify({ success: true, message: 'Report gesendet!' }));
            } catch (error) {
                res.writeHead(400);
                res.end(JSON.stringify({ success: false, error: error.message }));
            }
        });
    } else if (pathname === '/api/stats' && req.method === 'GET') {
        // Mock endpoint f√ºr Demo
        res.writeHead(200);
        res.end(JSON.stringify({
            surveys: 25,
            avgNps: 8.2,
            avgDesign: 4.1,
            topShowcase: 'Pantopia'
        }));
    } else {
        res.writeHead(404);
        res.end(JSON.stringify({ error: 'Not found' }));
    }
});

server.listen(PORT, () => {
    console.log(`üìä Analytics Service l√§uft auf Port ${PORT}`);
    console.log(`üìß Reports werden gesendet an: ${RECIPIENT_EMAIL}`);
    console.log(`üöÄ POST /api/send-report - Report senden`);
    console.log(`üìà GET /api/stats - Stats abrufen`);
});
